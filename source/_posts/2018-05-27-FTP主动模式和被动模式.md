---
title: FTP主动模式和被动模式
tags: Linux应用
abbrlink: ed8800d8
date: 2018-05-17 12:40:42
---

FTP只通过TCP连接，没有用于FTP的UDP组件。FTP不同于其他服务的是它使用了两个端口， 一个数据端口和一个命令端口(或称为控制端口)。通常21端口是命令端口，20端口是数据端口。根据FTP工作方式的不同，数据端口并不总是20，这就是主动与被动FTP的最大不同之处。（不管主动模式还是被动模式都是用TCP 21端口来传输控制信号的。）



## 主动FTP(PORT/Active)
客户端从一个任意的非特权端口N（N>1023）连接到FTP服务器的命令端口，也就是21端口。然后客户端开始监听端口N+1，并发送FTP命令“port N+1”到FTP服务器。接着服务器会从它自己的数据端口（20）连接到客户端指定的数据端口（N+1）。
![](http://ow3dy62zt.bkt.clouddn.com/IMG43.jpg)

针对FTP服务器前面的防火墙来说，必须允许以下通讯才能支持主动方式FTP：

1. 任何大于1024的端口到FTP服务器的21端口。（客户端初始化的连接）
2. FTP服务器的21端口到大于1023的端口。 （服务器响应客户端的控制端口）
3. FTP服务器的20端口到大于1023的端口。（服务器端初始化数据连接到客户端的数据端口）
4. 大于1023端口到FTP服务器的20端口（客户端发送ACK响应到服务器的数据端口）


## 被动FTP(PASV/Passive)
为了解决服务器发起到客户的连接的问题，人们开发了一种不同的FTP连接方式。这就是所谓的被动方式，当客户端通知服务器它处于被动模式时才启用。

在被动方式FTP中，命令连接和数据连接都由客户端发起，这样就可以解决从服务器到客户端的数据端口的入方向连接被防火墙过滤掉的问题。

当开启一个 FTP连接时，客户端打开两个任意的非特权本地端口（N > 1024和N+1）。第一个端口连接服务器的21端口，但与主动方式的FTP不同，客户端不会提交PORT命令并允许服务器来回连它的数据端口，而是提交 PASV命令。这样做的结果是服务器会开启一个任意的非特权端口（P > 1024），并发送PORT P命令给客户端。然后客户端发起从本地端口N+1到服务器的端口P的连接用来传送数据。

![](http://ow3dy62zt.bkt.clouddn.com/IMG44.jpg)

对于服务器端的防火墙来说，必须允许下面的通讯才能支持被动方式的FTP:

1. 从任何大于1023的端口到服务器的21端口 （客户端初始化的连接）
2. 服务器的21端口到任何大于1023的端口 （服务器响应到客户端的控制端口的连接）
3. 从任何大于1023端口到服务器的大于1023端口 （客户端初始化数据连接到服务器指定的任意端口）
4. 服务器的大于1023端口到远程的大于1023的端口（服务器发送ACK响应和数据到客户端的数据端口）
 



## 主动与被动FTP优缺点：
主动FTP对FTP服务器的管理有利，但对客户端的管理不利。因为FTP服务器企图与客户端的高位随机端口建立连接，而这个端口很有可能被客户端的防火墙阻塞掉。被动FTP对FTP客户端的管理有利，但对服务器端的管理不利。因为客户端要与服务器端建立两个连接，其中一个连到一个高位随机端口，而这个端口很有可能被服务器端的防火墙阻塞掉。

幸运的是，有折衷的办法。既然FTP服务器的管理员需要他们的服务器有最多的客户连接，那么必须得支持被动FTP。我们可以通过为FTP服务器指定一个有限的端口范围来减小服务器高位端口的暴露。这样，不在这个范围的任何端口会被服务器的防火墙阻塞。虽然这没有消除所有针对服务器的危险，但它大大减少了危险。





## 总结

主动FTP：
　　命令连接：客户端 >1023端口 -> 服务器 21端口
　　数据连接：客户端 >1023端口 <- 服务器 20端口 

被动FTP：
　　命令连接：客户端 >1023端口 -> 服务器 21端口
　　数据连接：客户端 >1023端口 -> 服务器 >1023端口

主动模式是从服务器端向客户端发起连接；被动模式是客户端向服务器端发起连接。两者的共同点是都使用 21端口进行用户验证及管理，差别在于传送数据的方式不同，PORT模式的FTP服务器数据端口固定在20，而PASV模式则在1024-65535之间随机

PORT（主动）方式的连接过程是：客户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，客户端在命令链路上用PORT命令告诉服务器：“我打开了XXXX端口，你过来连接我”。于是服务器从20端口向客户端的XXXX端口发送连接请求，建立一条数据链路来传送数据。

PASV（被动）方式的连接过程是：客户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，服务器在命令链路上用PASV命令告诉客户端：“我打开了XXXX端口，你过来连接我”。于是客户端向服务器的XXXX端口发送连接请求，建立一条数据链路来传送数据。



当NAT(Network Address Translation)设备以主动模式访问FTP服务器时，由于NAT设备不会聪明的变更FTP包中的IP地址，从而导致无法访问服务器。

大部分互联网应用都是被动模式，因为大部分客户端都是在路由器后面，没有独立的公网IP地址，服务器想要主动连接客户端，难度太大，在现在真实的互联网环境里面几乎是不可能完成的任务。

大部分FTP客户端默认使用PASV方式，在大部分FTP客户端的设置里，常见到的字眼都是“PASV”或“被动模式”。



## vsftpd配置
```
# vi /etc/vsftpd/vsftpd.conf
pasv_enable=YES
pasv_min_port=3000
pasv_max_port=4000
```



参考：

* https://www.centos.bz/2012/08/ftp-port-pasv-mode/
* http://www.serv-u.com/kb/1138/Active-and-Passive-FTP-Transfers-Defined
* http://blog.sina.com.cn/s/blog_5cdb72780100jwm9.html
* http://www.rfyy.net/archives/2641.html
* https://my.oschina.net/binny/blog/17469
* https://zhuanlan.zhihu.com/p/36403412
* http://www.cnblogs.com/xiaohh/p/4789813.html
---
title: 计算机网络 数据链路层
tags: 计算机网络
abbrlink: 2f41be1
date: 2018-06-20 20:52:11
---

> 其实本文中数据链路层讲了两部分，一部分是针对广域网的PPP，另一部分是针对局域网（以太网）的CSMA/CD


## 基本概念

### 信道类型
数据链路层使用的信道主要有以下两种类型
**点对点信道**。这种信道使用 **一对一** 的点对点通信方式。用于**广域网**，使用**PPP协议**
**广播信道**。这种信道使用 **一对多** 的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的**共享信道协议**来协调这些主机的数据发送。用于**局域网**，使用**CSMA/CD协议**

<!--more-->
### 链路和数据链路
**链路** (link) 是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。一条链路只是一条通路的一个组成部分。（物理层）

**数据链路** (data link) 除了物理线路外，还必须有 **通信协议** 来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。（链路+协议）

现在最常用的方法是使用适配器（即**网卡**）来实现这些协议的硬件和软件。一般的适配器都包括了数据链路层和物理层这两层的功能。

![](/img/IMG110.png)


## 数据链路层的三个基本问题

### 封装成帧
封装成帧 (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。
确定帧的界限。首部和尾部的一个重要作用就是进行帧定界。
帧=帧头+帧尾+物理层地址+校验值
![](/img/IMG111.png)
![](/img/IMG112.png)


### 透明传输
如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地 “找到帧的边界”。

![](/img/IMG113.png)

**解决方法**：
**字节填充** (byte stuffing) 或**字符填充** (character stuffing)。
1. 发送端的数据链路层在数据中出现控制字符 `SOH` 或`EOT`的前面插入一个转义字符`ESC` (其十六进制编码是 1B)。
2. 接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。
3. 如果转义字符也出现在数据当中，那么应在转义字符前插入一个转义字符，当接收端收到连续的两个转义字符时，就删除其中前面的一个

之所以称为透明传输，是因为插入转义和删除转义是无法感受到的
![](/img/IMG114.png)

### 差错控制

在传输过程中可能会产生**比特差错**：1 可能会变成 0 而 0 也可能变成 1。
在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率BER (Bit Error Rate)**。

误码率与信噪比有很大关系
为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施
如果发现错误并**不进行纠错而直接丢弃**，目标发现没有接收到会要求重发，这是传输层的事情

#### 循环冗余检验 CRC
CRC是差错检测中最常见的方法

在发送端，先把数据划分为组。假定每组 k 个比特。
假设待传送的一组数据 M = 101001（现在 k = 6）。我们在 M 的后面再添加供差错检测用的 n 位冗余码一起发送。
冗余码的计算举例
![](/img/IMG115.png)
![](/img/IMG116.png)
加法没有进位，减法没有借位，等同于异或运算
余数的位数等于n，不足补零

**FCS**
在数据后面添加上的冗余码称为帧检验序列 FCS (Frame Check Sequence)。
CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码。FCS可以用CRC这种方法得出，但CRC并非用来获得FCS的唯一方法

**检验**
**接收端**对收到的每一帧进行CRC检验
若得出的余数R=0，则判定这个帧没有差错，就接受
若余数R不等于0,则判定这个帧有差错，就丢弃

**特点**
这种检测方法并不能确定究竟是哪一个或哪几个比特出现了差错
除数P越大，检错能力越强
只要经过严格的挑选，并使用位数足够多的除数P，那么出现检测不到的差错的概率就很小

仅用循环冗余检验CRC差错检测技术只能做到**无差错接受**，”无差错接受” 是指：“凡是接收端数据链路层接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）。
要做到“可靠传输”（即发送什么就收到什么）就必须加上**确认**和**重传**机制

在数据链路层使用 CRC 检验，能够实现无比特差错的传输，但这还不是可靠传输。




## 点对点信道的数据链路层——PPP协议 
PPP协议 点对点协议 Point-to-Point Protocal
用于点到点通信
现在全世界使用得最多的数据链路层协议
用户使用拨号电话线接入因特网时，一般都是使用PPP协议

### 使用场合
用户通过拨号连入ISP（电信、联通），点对点的。ISP给用户分配IP地址。PPP协议作用于之间，为用户和ISP提供规则：在连上网线的基础上还需要遵守拨号和利用IP地址才能上网的规则。PPP能够计费，能够显示上网时间和上网流量等等
![](/img/IMG117.png)


### PPP 协议满足的需求：
- 简单——这是首要的要求，对帧不需要纠错，不需要流量控制，在接收方收到帧后用CRC检测，正确接收，错误就丢弃
- 封装成帧：从PPP协议的帧格式可以看出PPP协议封装成帧。在数据链路层以帧为单位进行传输
- 透明性：为了防止信息部分出现帧定界序列7E，而使网络误以为帧结束
- 差错检测：能够利用CRC进行差错检测 
- 多种网络层协议：能够支持多种高层协议的运行，比如IP协议等
- 多种类型链路：支持在光线等不同物理链路
- 检测连接状态：当拨号密码错误、连接错误时，PPP协议会提示错误信息
- 最大传送单元：一般要传输的数据不能超过1500个字节
- 网络层地址协商：拨号成功后，PPP协议能给用户分配网络层的IP地址
- 数据压缩协商：比如要传0000000011111111，16个比特。经过压缩算法后，只需要告诉对方要传8个0，8个1。接收方收到后再根据算法将16个0，16个1解压成0000000011111111。这样能够节省带宽



### PPP 协议不需要的功能：
- 纠错 
- 流量控制 
- 序号 
- 多点线路 
- 半双工或单工链路 


### PPP 协议的组成：
1. 数据链路层协议（HDLC）可以用于异步串行或同步串行方法
2. 链路控制协议 LCP (Link Control Protocol)建立并维护数据链路连接，身份验证，流量统计
3. 网络控制协议 NCP (Network Control Protocol)允许在点到点连接上使用多种网络层协议

![](/img/IMG118.png)

如果拨号身份验证成功了，则LCP负责建立数据链路，当LCP建立好了链路后，那么NCP就可以通了，NCP就分配一个IP给我们上网


### PPP 协议的帧格式：
![](/img/IMG119.png)

- 标志字段`F=0x7E`(符号`0x`表示后面的字符是用十六进制表示，十六进制的7E用二进制表示是`01111110`)
- 地址字段A只置为`0xFF`。地址字段实际上并不起作用
- 控制字段C通常置为`0x03`
- PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节。
- PPP有一个2字节的协议字段用来表示信息字段的内容类型
    - 0x0021：PPP帧的信息字段是IP数据段
    - 0xC021：PPP链路控制数据
    - 0x8021：网络控制数据 
    - 0xC023：安全性认证PAP
    - 0xC025：LQR
    - oxC223：安全性认证CHAP


### PPP 协议的透明传输问题：
当 PPP 用在同步传输链路时，协议规定采用硬件来完成比特填充（和 HDLC 的做法一样）。 当 PPP 用在异步传输时，就使用一种特殊的字符填充法。
**字节填充**
以字节为单位，应用于异步网络中
- 将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列 (0x7D, 0x5E)
- 若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列 (0x7D, 0x5D)
- 若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变。

**零比特填充**
以比特为单位，应用于同步网络中
在同步网络中传的比特流，所以不一定是8的倍数了。需要解决比特流的透明传输 
PPP 协议用在`SONET/SDH`链路时，是使用同步传输（一连串的比特连续传送）。这时 PPP 协议采用零比特填充方法来实现透明传输。
- 在发送端，只要发现有 **5 个连续 1**，则立即填入一个 0。
- 接收端对帧中的比特流进行扫描。每当发现 5 个连续 1 时，就把这 5 个连续 1 后的一个 0 删除。

![](/img/IMG120.png)

PPP 协议不提供序号和确认的可靠传输。
原因：
1. 在数据链路层出现差错的概率不大时，使用比较简单的 PPP 协议较为合理。
2. 在因特网环境下，PPP 的信息字段放入的数据是 IP 数据报。数据链路层的可靠传输并不能够保证网络层的传输也是可靠的。
3. 帧检验序列 FCS 字段可保证无差错接受。


### PPP 协议的工作状态
1. 当用户拨号接入 ISP 时，路由器的调制解调器对拨号做出确认，并建立一条物理连接。
2. PC 机向路由器发送一系列的 LCP 分组（封装成多个 PPP 帧）。
3. 这些分组及其响应选择一些 PPP 参数，和进行网络层配置，NCP 给新接入的 PC 机分配一个临时的 IP 地址，使 PC 机成为因特网上的一个主机。
4. 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接。


PPP 是一种**验证方式**，验证成功后会分配给用户一个 IP 地址。
PPP 协议**已不是纯粹的数据链路层的协议**，它还包含了物理层和网络层的内容。



## 广播信道的数据链路层——CSMA/CD协议


### 局域网的拓扑
![](/img/IMG121.png)

- **星型拓扑结构**：每个结点都由一条单独的通信线路与中心结点连结
    - 优点：结构简单、容易实现、便于管理，连接点的故障容易监测和排除
    - 缺点：中心结点出现故障会导致网络的瘫痪
- **环形拓扑结构**：各结点通过通信线路组成闭合回路，环中数据只能单向传输
    - 优点：结构简单、容易实现，适合使用光纤，传输距离远，传输延迟确定
    - 缺点：任意结点出现故障都会造成网络瘫痪，另外故障诊断也较困难
- **总线拓扑结构**：是将网络中的所有设备通过相应的硬件接口直接连接到公共总线上，结点之间按广播方式通信，一个结点发出的信息，总线上的其它结点均可 “收听” 到
    - 优点：结构简单、布线容易、可靠性较高，易于扩充，是局域网常采用的拓扑结构
    - 缺点：所有的数据都需经过总线传送，出故障诊断较为困难
- **树型拓扑结构**：一种层次结构，结点按层次连结，信息交换主要在上下结点之间进行，相邻结点或同层结点之间一般不进行数据交换
    - 优点：连结简单，维护方便，适用于汇集信息的应用要求
    - 缺点：资源共亨能力较低，可靠性不高，任何一个工作站或链路的故障都会影响整个网络的运行


### 局域网最主要的特点
网络为一个单位所拥有，且地理范围和站点数目均有限

### 局域网的优点
1. 具有广播功能，从一个站点可佷方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源
2. 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变
3. 提高了系统的可靠性、可用性和生存性

### 局域网中的冲突域与广播域
最初的以太网是将许多计算机都连接到一根总线上，当初认为这样的连接方法既简单又可靠，因为总线上没有有源器件（有电源的器件）
![](/img/IMG122.png)

总线上的每一个工作的计算机都能检测到B发送的数据信号
由于只有计算机D的地址（mac地址）与数据帧首部写入的地址一致，因此只有D才接收这个数据帧
其他所有的计算机（A，C和E）都检测到一是发送给它们的数据帧，因此就丢弃这个数据帧而不能够收下来
具有广播特性的总线上实现了一对一的通信

**广播域**： 一台计算机发送数据，连接在总线上的所有计算机都能收到数据，所有的计算机在同一个广播域中。
**冲突域**： 当一台计算机发送数据时，总线被占用，此时所有连接在总线上的其他计算机都不能再发送数据了。
所有的计算机又处于同一个冲突域中。



### 局域网各终端共享通信媒体（线路介质）的方法
- 静态划分信道
    - 频分复用
    - 时分复用
    - 波分复用
    - 码分复用
- 动态媒体接入控制（多点接入）
    - 随机接入：用户想什么时候在线路上发送数据就什么时候发，什么都不用管。如果恰好有多个用户同时刻发送，则在线路上发生碰撞，需要 **CSMA/CD 协议协调**（主要被以太网采用）这是以太网最需要解决的问题。
    - 受控接入，如多点线路探询（polling），或轮询（目前已不被采用）

静态划分的主要问题是增加新的计算机不方便，需要重新分配信道


### CSMD/CD 载波监听多点接入/碰撞检测

CSMA/CD 表示Carrier Sense Multiple Access with Collision Detection

**多点接入** 表示许多计算机以多点接入的方式连接在一根总线上。
**载波监听** 是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞。 总线上并没有什么 “载波”。因此， “载波监听” 就是用电子技术检测总线上有没有其他计算机发送的数据信号。
**碰撞检测** 就是计算机边发送数据边检测信道上的信号电压大小。当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）。当一个站检测到的**信号电压**摆动值超过一定的**门限值**时，就认为总线上至少有两个站同时在发送数据，表明产生了**碰撞**。所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测”。
**检测到碰撞后**在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息来。每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送。



#### 载波监听后仍然出现碰撞的可能

电磁波在总线上的有限传播速率的影响当某个站监听到总线是空闲时，也可能总线并非真正是空闲的。 A 向 B 发出的信息，要经过一定的时间后才能传送到 B。B 若在 A 发送的信息到达 B 之前发送自己的帧(因为这时 B 的载波监听检测不到 A 所发送的信息)，则必然要在某个时间和 A 发送的帧发生碰撞。碰撞的结果是两个帧都变得无用。

![](/img/IMG123.png)




### CSMA/C的D重要特性
使用CSMA/CD协议的以太网不能进行全双工通信而只能进行双向交替通信（**半双工通信**）
每个站在发送数据之后的一小段时间内，存在遭遇碰撞的可能性。所以不能保证在一定时间内一定能把数据发送出去。
这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率（因为碰撞会降低效率）

可以看出，如果A到B之间的**线路越长**（传播时延τ受传播媒介长度影响），那么**接受到碰撞信息的时间也会越长**，所以**CSMA/CD协议适合用在线路较短的局域网和以太网**中。这也是局域网范围受限的原因之一。

   

### 争用期

A能收到碰撞的最长时间为，当数据到达B后，B刚好发送数据，在主机B上发生了碰撞。最先发送数据帧的站，在发送数据帧后至多经过时间 `2τ`就可知道发送的数据帧是否遭受了碰撞。如果这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

#### 以太网的争用期

以太网的端到端往返时延**2τ**称为争用期，或碰撞窗口。通常，取 51.2 ms 为争用期的长度。对于 10 Mb/s 以太网，在争用期内可发送512 bit，即 64 字节。以太网在发送数据时，若前 64 字节未发生冲突，则后续的数据就不会发生冲突。

#### 最短有效帧长 

如果发生冲突，就一定是在发送的前 64 字节之内。 
由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节。 
以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧。

### 强化碰撞
当发送数据的站一旦发现发生了碰撞时：
1. 立即停止发送数据；
2. 再继续发送若干比特的人为干扰信号 (jamming signal)，以便让所有用户都知道现在已经发生了碰撞。


### 二进制指数类型退避算法

发生碰撞的站在停止发送数据后，要推迟（退避）一个随机时间才能再发送数据。尽量避免再次发生碰撞

确定基本退避时间，一般是取为争用期 2t。
定义参数 k，k = Min[重传次数n, 10]
从整数集合[0,1,…, (2的K次方-1)]中随机地取出一个数，记为 r。重传所需的时延就是 r 倍的基本退避时间。
当重传达 16 次仍不能成功时即丢弃该帧，并向高层报告。


## 以太网

### 以太网两个标准

1. DIX Ethernet V2 是世界上第一个局域网产品（以太网）的规约。
2. IEEE 的 802.3 标准。

DIX Ethernet V2 标准与 IEEE 的 802.3 标准只有很小的差别，因此可以将 802.3 局域网简称为“以太网”。说白了： **以太网就是局域网**。
严格说来，“以太网”应当是指符合 DIX Ethernet V2 标准的局域网


10M以太网使用CSMA/CD协议


### 以太网与数据链路层的两个子层    

为了使数据链路层能更好地适应多种局域网标准，802 委员会就将局域网的数据链路层拆成两个子层：

1. **逻辑链路控制 LLC** (Logical Link Control)子层
2. **媒体接入控制 MAC** (Medium Access Control)子层

与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关，不管采用何种协议的局域网对 LLC 子层来说都是透明的。

由于 TCP/IP 体系经常使用的局域网是 DIX Ethernet V2 而不是 802.3 标准中的几种局域网，因此现在 802 委员会制定的逻辑链路控制子层 LLC（即 802.2 标准）的作用已经不大了，即现在LLC子层几乎不提了。

很多厂商生产的适配器上就仅装有 MAC 协议而没有 LLC 协议。

### 以太网提供的服务

以太网提供的服务是**不可靠的交付**，即尽最大努力的交付。
当接收站收到**有差错的数据帧时就丢弃**此帧，其他什么也不做。差错的纠正由传输层来决定。
如果高层发现丢失了一些数据而进行重传，但以太网并不知道这是一个重传的帧，而是当作一个新的数据帧来发送。

![](/img/IMG124.jpg)
如图所示，PC1发送数据给PC0，在以太网上，ＲＡ接收到有差错的数据帧时就直接丢弃。如果PC0的高层（网络层以上）发现数据在途中丢失了，就会要求PC1重新发送一份。 


### 传统以太网的拓扑——使用集线器的星形拓扑结构

传统以太网最初是使用**粗同轴电缆**，后来演进到使用比较便宜的**细同轴电缆**，最后发展为使用更便宜和更灵活的**双绞线**。不用电缆而使用无屏蔽双绞线。每个站需要用两对双绞线，分别用于发送和接收。这种以太网采用星形拓扑，在星形的中心则增加了一种可靠性非常高的设备，叫做**集线器**(hub) 。

需要注意的是： 现在中间的可靠设备一般不用集线器了，现在组网去市场花个便宜的钱都是用交换机组网的。

![](/img/IMG125.jpg)
100m以内

### 集线器（hub）

集线器是使用电子器件来模拟实际电缆线的工作，因此整个系统仍然像一个传统的以太网那样运行。
使用集线器的以太网在逻辑上仍是一个总线网，各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线。 
集线器很像一个多接口的转发器，工作在**物理层**。 集线器是傻瓜式的，它没有智能作用，看不见什么信号。只知道机械的传输，也不管目的地址什么的，反正就是有信号就传。

![](/img/IMG126.jpg)

接在工作站网卡上的8根双脚线有两根是发送数据的，有两根是接收数据的。A发送数据数据到集线器后，B和C都能收到，C发送数据到集线器后，A和B也能收到。发送者自己是收不到自己发出去的数据的。

需要注意的是： 这是早期的集线器，在芯片电路还没有出来之前的，集线器里面都是线连接的。现在的集线器都是芯片电路板了。集线器使用了大规模集成电路芯片，因此这样的硬件设备的可靠性已大大提高了。



### 以太网速度标准

10BASE-T（10Mb/s）的通信距离稍短，每个站到集线器的距离不超过 100 m。这种 10 Mb/s 速率的无屏蔽双绞线星形网的出现，既降低了成本，又提高了可靠性。 

10BASE-T 双绞线以太网的出现，是局域网发展史上的一个非常重要的里程碑，它为以太网在局域网中的统治地位奠定了牢固的基础。

其他：100Base-FX(百兆快速以太网，使用光纤)、100Base-T和100Base-T4….

10：10M/s
BASE：基带信号
T：双绞线
FX：光纤

### 以太网信道利用率
因为每个站点发送数据时可能产生碰撞的可能，所以此时的信道不会被利用，所以利用率就会变低。

以太网的信道被占用的情况：
我们知道争用期长度为 2τ，即端到端传播时延的两倍。检测到碰撞后不发送干扰信号。
如果帧长为 L (bit)，数据发送速率为 C (b/s)，因而帧的发送时间为 L/C = T0 (s)。

一个帧从开始发送，经可能发生的碰撞后，将再重传数次，到发送成功且信道转为空闲(即再经过τ时间使得信道上无信号在传播)时为止，是发送一帧所需的平均时间。

![](/img/IMG127.jpg)


要提高以太网的信道利用率，就必须减小τ 与 T0 之比。在以太网中定义了参数 a，它是以太网单程端到端时延τ与帧的发送时间 T0 之比： a=τ/T0      

a→0 表示一发生碰撞就立即可以检测出来，并立即停止发送，因而信道利用率很高。
a 越大，表明争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，使得信道利用率明显降低。

a并不是信道利用率，只是为了描述信道利用率的一个参数而已
从式子可以得出，要想a变小，则τ尽量变小，而T0尽量要大。
当数据率C一定时，T0=L（帧长）/C 。所以以太网的帧长L尽量要长些，这样T0会增大，a会变小。
当然也不能太长，太长后信道利用率过高会引起信道延迟成倍增加（ 信道利用率越高，数据线路上拥堵的可能性就越大，当高到一定程度后，会增加数据在线路上的延时）。
同时，以太网的连线的长度尽量短些，这样端到端的传播时间τ会变小，a会减小。当然也不能太短，太长后信道利用率过高会引起信道延迟成倍增加。


#### 信道利用率的最大值

在理想化的情况下，以太网上的各站发送数据都不会产生碰撞（这显然已经不是 CSMA/CD，而是需要使用一种特殊的调度方法），即总线一旦空闲就有某一个站立即发送数据。

发送一帧占用线路的时间是 T0 +τ，而帧本身的发送时间是 T0。于是我们可计算出理想情况下的极限信道利用率 Smax为：  

![](/img/IMG128.jpg)



## MAC地址
在局域网中，硬件地址又称为**物理地址**，或** MAC 地址**。 （**48位地址**）

802 标准所说的“地址”严格地讲应当是每一个站的“名字”或标识符。 其实我们教材中说的地址并不是很确切，但是我们习惯将这种 48 位的“名字”称为“地址”，所以本书也采用这种习惯用法。

- IEEE 的注册管理机构 RA 负责向厂家分配地址字段的前三个字节(即**高位 24 位**)。
- 地址字段中的后三个字节(即低位 24 位)由厂家自行指派，称为**扩展标识符**，必须保证生产出的适配器**没有重复地址**。
- 一个地址块可以生成224个不同的地址。这种 48 位地址称为 **MAC-48**，它的通用名称是**EUI-48**。
- “MAC地址”实际上就是适配器地址或适配器标识符EUI-48。在出厂前就烧录在了我们的网卡中。


如果在一个局域网内（同一个交换机连接下）有相同的MAC地址，则会引起冲突，导致一方不能正常上网。
我们说MAC地址是刻在网卡适配器中的，是不可以更改的，但是我们可以指定一个MAC地址，让计算机应用指定的MAC地址，而不用网卡上固定的MAC地址。
windows修改mac地址方法：本地连接---更改适配器设置---本地连接属性---配置----高级---网络地址（本地管理的地址）


### 适配器检查 MAC 地址

适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址
如果是发往本站的帧则收下，然后再进行其他的处理。否则就将此帧丢弃，不再进行其他的处理。

“发往本站的帧”包括以下三种帧： 
- 单播(unicast)帧（一对一）
- 广播(broadcast)帧（一对全体）（源mac地址：FF:FF:FF:FF:FF:FF）
- 多播(multicast)帧（一对多）



### MAC帧格式 
常用的以太网MAC帧格式有两种标准 ：
1. DIX Ethernet V2 标准
2. IEEE 的 802.3 标准

最常用的 MAC 帧是以太网 V2 的格式。



MAC帧V2 格式
![](/img/IMG129.jpg)
最小长度64字节（最短有效帧长，参考争用期）-18字节的首部和尾部（6+6+2+4）=数据字段的最小长度
为了达到比特同步在传输媒体上实际传送的要比 MAC 帧还多 8 个字节

### 无效的 MAC 帧  

当适配器收到MAC帧后，会检查是否是有效的MAC帧。
- 帧的长度不是整数个字节；
- 用收到的帧检验序列 FCS 查出有差错；
- 数据字段的长度不在 46 ~ 1500 字节之间。
- 有效的 MAC 帧长度为 64 ~ 1518 字节之间。

对于检查出的无效 MAC 帧就简单地丢弃。以太网不负责重传丢弃的帧。 


### 帧间最小间隔             

帧间最小间隔为 9.6 μs，相当于 96 bit 的发送时间。
一个站在检测到总线开始空闲后，还要等待 9.6 μs 才能再次发送数据。
这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接收下一帧的准备。 

9.6 μs × 10Mb/s = 96bit


## 扩展以太网


扩展可以在物理层上也可在链路层上，但从网络层看依然是一个局域网。
以太网主机之间的距离不能太远（10BASE-T规定200米）

### 在物理层扩展局域网

主机使用光纤和一对光纤调制解调器连接到集线器
![](/img/IMG130.png)
![](/img/IMG131.png)
用多个集线器可连成更大的局域网

**优点**
使原来属于不同碰撞域的局域网上的计算机能够进行跨碰撞域的通信。
扩大了局域网覆盖的地理范围。（使用光纤可以扩大到几千米）
数量增加


**缺点**
碰撞域增大了，但总的吞吐量并未提高。
如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。
三个碰撞域连起来后，最大吞吐率仍然是一个系的最大吞吐率。因为其中任何一台主机通信，其他主机都不能通信。





### 在数据链路层扩展局域网

在数据链路层扩展局域网是使用**网桥**。
网桥工作在数据链路层，它**根据 MAC 帧的目的地址对收到的帧进行转发**。

网桥具有过滤帧的功能。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的 MAC 地址，然后再确定将该帧转发到哪一个接口。

#### 网桥的内部结构

网桥具有多个接口
每个接口连接一个网段

若网桥从接口1收到从主机1向主机5的帧，则把帧发到接口2转发出去。
若网桥从接口1收到从主机2发到主机3的帧，则丢弃。因为主机2和3位于同一桥段，不用转发。
![](/img/IMG132.png)


#### 使用网桥带来的好处

过滤通信量，增大吞吐率。 
扩大了物理范围。主机数量
提高了可靠性。只影响个别网段
可互连不同物理层、不同 MAC 子层和不同速率（如10 Mb/s 和 100 Mb/s 以太网）的局域网。

网桥使各网段成为隔离开的碰撞域

 
#### 使用网桥带来的缺点

存储转发增加了时延。存储、查表、碰撞检测 
在MAC 子层并没有流量控制功能。 网桥的缓存可能溢出，帧丢失。
网桥只适合于用户数不太多(不超过几百个)和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞。这就是所谓的广播风暴。
路由器可以阻断网络风暴

#### 网桥和集线器（或转发器）不同

集线器在转发帧时，不对传输媒体进行检测。
网桥在转发帧之前必须执行 CSMA/CD 算法。
若在发送过程中出现碰撞，就必须停止发送和进行退避。

#### 透明网桥

目前使用得最多的网桥是透明网桥(transparent bridge)。 
“透明”是指局域网上的站点并不知道所发送的帧将经过哪几个网桥，因为网桥对各站来说是看不见的。 
透明网桥是一种即插即用设备，其标准是 IEEE 802.1D。


#### 自学习算法
网桥使用自学习算法处理收到的帧和建立转发表，网桥并不是一开始就知道所连接网络的所有mac地址的，而是通过自学习算法建立转发表

![](/img/IMG133.png)
![](/img/IMG134.png)
![](/img/IMG135.png)
![](/img/IMG136.png)

 

 

1. 若从 A 发出的帧从接口 x 进入了某网桥，那么从这个接口出发沿相反方向一定可把一个帧传送到 A。
2. 网桥每收到一个帧，就记下其源地址和进入网桥的接口，作为转发表中的一个项目。
3. 在建立转发表时是把帧首部中的源地址写在“地址”这一栏的下面
4. 在转发帧时，则是根据收到的帧首部中的目的地址来转发的。这时就把在“地址”栏下面已经记下的源地址当作目的地址，而把记下的进入接口当作转发接口。

如果一个接口有多个mac说明，这个接口连接的是网桥或者交换机


#### 网桥在转发表中登记以下三个信息 
网桥转发表中的信息：**地址**、**接口**和**帧进入该网桥的时间**。

这是因为以太网的拓扑可能经常会发生变化，站点也可能会更换适配器（这就改变了站点的地址）。
把每个帧到达网桥的时间登记下来，就可以在转发表中只保留网络拓扑的最新状态信息。这样就使得网桥中的转发表能反映当前网络的最新拓扑状态。 

 

#### 网桥的自学习和转发帧的步骤归纳 
网桥收到一帧后先进行自学习。查找转发表中与收到帧的源地址有无相匹配的项目。如没有，就在转发表中增加一个项目（源地址、进入的接口和时间）。如有，则把原有的项目进行更新。
转发帧。查找转发表中与收到帧的目的地址有无相匹配的项目。
如有，则按转发表中给出的接口进行转发。
如没有，则通过所有其他接口（但进入网桥的接口除外）进行转发。
若转发表中给出的接口就是该帧进入网桥的接口，则应丢弃这个帧（因为这时不需要经过网桥进行转发）。

 

#### 透明网桥使用了生成树算法 
这是为了避免产生转发的帧在网络中不断地兜圈子

![](/img/IMG137.png)

互连在一起的网桥在进行彼此通信后，就能找出原来的网络拓扑的一个子集。在这个子集里，整个连通的网络中不存在回路，即在任何两个站之间只有一条路径。 

为了得出能够反映网络拓扑发生变化时的生成树，在生成树上的根网桥每隔一段时间还要对生成树的拓扑进行更新。


### 多接口网桥——以太网交换机

1990 年问世的交换式集线器(switching hub)，可明显地提高局域网的性能。交换式集线器常称为**以太网交换机**(switch)或**第二层交换机**（表明此交换机工作在数据链路层）。以太网交换机通常都有十几个接口。因此，以太网交换机实质上就是一个多接口的网桥，可见交换机工作在数据链路层。

#### 以太网交换机的特点
以太网交换机的每个接口都直接与主机相连，并且一般都工作在**全双工方式**。交换机能同时连通许多对的接口，使每一对相互通信的主机都能像独占通信媒体那样，进行无碰撞地传输数据。 以太网交换机由于使用了专用的交换结构芯片，其交换速率就较高。

**独占传输媒体的带宽**
对于普通 10 Mb/s 的共享式以太网，若共有 N 个用户，则每个用户占有的平均带宽只有总带宽(10 Mb/s)的 N 分之一。使用以太网交换机时，虽然在每个接口到主机的带宽还是 10 Mb/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此对于拥有 N 对接口的交换机的总容量为 N×10 Mb/s。这正是交换机的最大优点。

对于普通共享式HUB 若N个用户 总带宽：10Mb/s 每个用户占有平均带宽= 10M/N

### 以太网交换机的交换方式
存储转发方式
把整个数据帧先缓存后再进行处理。
直通 (cut-through) 方式
接收数据帧的同时就立即按数据帧的目的 MAC 地址决定该帧的转发接口，因而提高了帧的转发速度。
缺点是它不检查差错就直接将帧转发出去，因此有可能也将一些无效帧转发给其他的站。


## 虚拟局域网
虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组。这些网段具有某些共同的需求。每一个 VLAN 的帧都有一个明确的标识符，指明发送这个帧的工作站是属于哪一个 VLAN。虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型局域网。
在缺省配置的情况下，交换机的所有端口属于同一 VLAN。连接在不同交换机上的、属于同一 VLAN 的数据帧必须通过 Trunk 链路传输。


![](/img/IMG138.png)







## 高速以太网
速率达到或超过 100 Mbit/s 的以太网称为高速以太网。100BASE-T 以太网又称为快速以太网 (Fast Ethernet)。

可在全双工方式下工作而无冲突发生。在全双工方式下工作时，不使用 CSMA/CD 协议。
MAC 帧格式仍然是 802.3 标准规定的。
保持最短帧长不变，但将一个网段的最大电缆长度减小到 100 m。
帧间时间间隔从原来的 9.6 μs 改为现在的 0.96 μs。

## 吉比特以太网
允许在 1 Gbit/s 下全双工和半双工两种方式工作。
使用 IEEE 802.3 协议规定的帧格式。
在半双工方式下使用 CSMA/CD 协议，全双工方式不使用 CSMA/CD 协议。












http://blog.51cto.com/zhaoyuqiang/1575315
